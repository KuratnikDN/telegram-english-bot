import os
import requests
import csv
import random
import telebot
import schedule
import time
from threading import Thread

print("–ë–æ—Ç —Å—Ç–∞—Ä—Ç—É–µ—Ç...")

# === –ù–ê–°–¢–†–û–ô–ö–ò ===
TOKEN = os.getenv("TOKEN")
CHAT_ID = os.getenv("CHAT_ID")
SHEET_URL = os.getenv("SHEET_URL")

bot = telebot.TeleBot(TOKEN)

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ–≤–∞ –∏–∑ Google Sheets
def load_words():
    try:
        r = requests.get(SHEET_URL)
        r.encoding = "utf-8"
        words = [row[0] for row in csv.reader(r.text.splitlines()) if row]
        return words
    except Exception as e:
        print("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤:", e)
        return []

# –û—Ç–ø—Ä–∞–≤–∫–∞ 10 —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–ª–æ–≤
def send_words():
    print("–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ª–æ–≤–∞...")
    words = load_words()
    if not words:
        print("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ–≤–∞")
        bot.send_message(CHAT_ID, "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ–≤–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã.")
        return
    selected = random.sample(words, min(10, len(words)))
    message = "üìö –°–ª–æ–≤–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è:\n" + "\n".join(selected)
    print("–û—Ç–ø—Ä–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ...")
    bot.send_message(CHAT_ID, message)

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (3 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å)
schedule.every().day.at("03:41").do(send_words)
schedule.every().day.at("15:00").do(send_words)
schedule.every().day.at("20:00").do(send_words)

# –§–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ –¥–ª—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
def schedule_loop():
    while True:
        schedule.run_pending()
        time.sleep(1)

Thread(target=schedule_loop).start()

# –ß—Ç–æ–±—ã –±–æ—Ç –Ω–µ –ø–∞–¥–∞–ª
bot.polling(none_stop=True)
